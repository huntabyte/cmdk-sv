<script lang="ts">
	import { Popover } from "bits-ui";
	import { onMount, tick } from "svelte";
	import SubItem from "./sub-item.svelte";
	import { FinderIcon, StarIcon, WindowIcon } from "./icons/index.js";
	import { Command } from "$lib/index.js";

	type Props = {
		listEl: HTMLElement | null;
		inputEl: HTMLInputElement | null;
		selectedValue: string;
	};

	let { listEl, inputEl, selectedValue = $bindable() }: Props = $props();

	let open = $state(false);

	onMount(() => {
		function handleKeydown(e: KeyboardEvent) {
			if (e.key === "k" && (e.metaKey || e.ctrlKey)) {
				e.preventDefault();
				open = true;
			}
		}

		document.addEventListener("keydown", handleKeydown);

		return () => {
			document.removeEventListener("keydown", handleKeydown);
		};
	});

	$effect(() => {
		if (!listEl) return;
		if (open) {
			listEl.style.overflow = "hidden";
		} else {
			listEl.style.overflow = "";
		}
	});

	$effect(() => {
		if (!open) {
			tick().then(() => inputEl?.focus());
		}
	});
</script>

<Popover.Root bind:open>
	<Popover.Trigger>
		{#snippet child({ props })}
			<button {...props} data-cmdk-raycast-subcommand-trigger="" aria-expanded={open}>
				Actions
				<kbd>⌘</kbd>
				<kbd>K</kbd>
			</button>
		{/snippet}
	</Popover.Trigger>
	{#if open}
		<Popover.Content preventScroll={true} class="raycast-submenu" side="top" align="end">
			<Command.Root>
				<Command.List>
					<Command.Group heading={selectedValue}>
						<SubItem shortcut="↵">
							<WindowIcon />
							Open Application
						</SubItem>
						<SubItem shortcut="⌘ ↵">
							<FinderIcon />
							Show in Finder
						</SubItem>
						<SubItem shortcut="⌘ I">
							<FinderIcon />
							Show Info in Finder
						</SubItem>
						<SubItem shortcut="⌘ ⇧ F">
							<StarIcon />
							Add to Favorites
						</SubItem>
					</Command.Group>
				</Command.List>
				<Command.Input placeholder="Search for actions..." />
			</Command.Root>
		</Popover.Content>
	{/if}
</Popover.Root>
